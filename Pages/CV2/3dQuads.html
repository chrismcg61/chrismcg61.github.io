<!DOCTYPE html>
<html>
<head>
	<title>3D Quads</title>
  
	<script src="https://cdn.rawgit.com/mrdoob/three.js/r124/build/three.min.js"></script>
	<script src="https://cdn.rawgit.com/mrdoob/three.js/r124/examples/js/libs/dat.gui.min.js"></script>
	<script src="https://cdn.rawgit.com/mrdoob/three.js/r124/examples/js/libs/stats.min.js"></script>
	<script src="https://cdn.rawgit.com/chrismcg61/TechDemos/1.94/MyLibs/Three/My3D.js"></script>
	<script src="https://cdn.rawgit.com/chrismcg61/TechDemos/1.94/Libs/PostFX.js"></script>
</head>

<body>
</body>



<script>
	MY3D.preInit(THREE);
	var stats = new Stats();  document.body.appendChild( stats.dom );
	var gui = new dat.GUI();

	var params = { camPosX:0.0,camPosY:1,camPosZ:3,   fogCol:0x0a2228,fogDensity:4.2,   Bloom:{intensity:1.5,radius:0.5,threshold:0.1},    };
	var gParams = { RESTART:ReInit,exposure:1.6,  lightCol:0xff2222,lightIntensity:0.2,lightPosX:0,lightPosY:2,lightPosZ:-5,   };
	var hiddenParams = { HiddenParams:params, };
	var showParams = { MainParams:gParams, };
	MY3D.addGuiParams(gui, hiddenParams, false, 10,0.01);
	MY3D.addGuiParams(gui, showParams, true, 10,0.01);

	var light,  gMesh, planeParticles;
	ReInit();
	function ReInit0(){
	  scene = new THREE.Scene();
	  scene.add(camera);  
	  renderer.toneMapping = THREE.ReinhardToneMapping;
	  renderer.shadowMap.enabled = true;  
	  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
	  MY3D.initBloom(params.Bloom.intensity,params.Bloom.radius,params.Bloom.threshold);  
	}
	function ReInit(){
	  planeParticles = [];
	  ReInit0();  
	  
	  light = new THREE.PointLight( gParams.lightCol, gParams.lightIntensity, 10, 1.9 );
	  scene.add( light );
	  {
		light.castShadow = true;  
		light.shadow.camera.near = 0.2;
		light.shadow.mapSize.width = light.shadow.mapSize.height = 1024;
	  }
	  var lightPane = new THREE.Mesh( new THREE.PlaneGeometry( 0.4,0.4 ), new THREE.MeshStandardMaterial() );  // new THREE.MeshBasicMaterial( {color: 0x00ff00} )
	  lightPane.position.z = -0.1;
	  light.add( lightPane );  
	  
	  var bumpMap = new THREE.TextureLoader().load("https://cdn.rawgit.com/chrismcg61/TechDemos/1.94/Media/Concrete.jpg");
	  bumpMap.wrapS = THREE.RepeatWrapping;   bumpMap.wrapT = THREE.RepeatWrapping;   bumpMap.repeat.set( 10, 10 );
	  const floorMat = new THREE.MeshStandardMaterial( {roughness:0.7,metalness:0.1, side:THREE.DoubleSide, bumpMap:bumpMap,bumpScale:0.01} );
	  const wallMat = floorMat.clone();   wallMat.bumpScale=0.9;  wallMat.metalness=0.4;
	  const shinyMat = floorMat.clone();   shinyMat.bumpScale=0;  shinyMat.roughness=0.4;shinyMat.metalness=0.9;
	  
	  const FLOOR_SIZE = 90;
	  const floor = new THREE.Mesh( new THREE.PlaneGeometry( FLOOR_SIZE,FLOOR_SIZE, 3,3 ),   floorMat );
	  floor.rotation.x = -Math.PI/2;
	  floor.receiveShadow = true;
	  scene.add( floor );
	  
	  const wall1 = new THREE.Mesh( new THREE.PlaneGeometry( FLOOR_SIZE,FLOOR_SIZE, 3,3 ),   wallMat );
	  wall1.position.x = 6;  wall1.rotation.y = -Math.PI/2;  
	  wall1.receiveShadow = true;
	  scene.add( wall1 );
	  const wall2 = wall1.clone(); wall2.position.x = -wall1.position.x;
	  scene.add( wall2 );
	  
	  gMesh = new THREE.Mesh( new THREE.BoxGeometry(),  shinyMat );
	  scene.add( gMesh );
	  gMesh.position.y = -0.6;
	  // var bufferGeo = new THREE.BufferGeometry();  
	  var newPlane = new THREE.Mesh( new THREE.PlaneGeometry( 0.1,0.1, 1,1 ),   shinyMat );
	  addQuads(newPlane, 500, false);
	  addQuads(newPlane, 2000, true);
	}
	function addQuads(quadMesh, nQuads, bMerge) {
	  for (i=0; i<nQuads; i++) {
		var newPlane = quadMesh.clone();
		newPlane.position.set( 8*(Math.random()-0.5), 0.8+4*Math.random(), -9*Math.random() );
		newPlane.rotation.set( 9*Math.random(),9*Math.random(),9*Math.random() );
		newPlane.castShadow = true;  
		planeParticles.push( newPlane );

		if(bMerge)gMesh.geometry.mergeMesh( newPlane );
		else  scene.add( newPlane );
	  }
	}


	animate();
	function animate() {
	  var now = Date.now()*0.0005;
	  requestAnimationFrame( animate );
	  composer.render();
	  // renderer.render( scene, camera );
	  stats.update();
	  
	  renderer.toneMappingExposure = Math.pow( gParams.exposure, 4.0 );
	  scene.background = new THREE.Color( params.fogCol );
	  scene.fog = new THREE.FogExp2( params.fogCol, params.fogDensity*0.01 );      
	  camera.position.set(params.camPosX,params.camPosY,params.camPosZ);
	  {
		light.position.set(gParams.lightPosX,  gParams.lightPosY + 0.3*Math.sin(now),  gParams.lightPosZ);
		light.intensity = gParams.lightIntensity;
		light.color = new THREE.Color(gParams.lightCol);
	  }
	  
	  for (i=0; i<planeParticles.length; i++) {  
		var newPlane = planeParticles[i];
		newPlane.rotation.y = now * (newPlane.position.y+2);
	  }
	}
</script>

</html>
