<!DOCTYPE html>
<html>
<head>
	<title>3D Points</title>
	
  
	<script src="https://cdn.rawgit.com/mrdoob/three.js/r124/build/three.min.js"></script>
	<script src="https://cdn.rawgit.com/mrdoob/three.js/r124/examples/js/libs/dat.gui.min.js"></script>
	<script src="https://cdn.rawgit.com/mrdoob/three.js/r124/examples/js/libs/stats.min.js"></script>
	<script src="https://cdn.rawgit.com/chrismcg61/TechDemos/1.94/MyLibs/Three/My3D.js"></script>
	<script src="https://cdn.rawgit.com/chrismcg61/TechDemos/1.94/Libs/PostFX.js"></script>
</head>

<body>
</body>



<script>
	MY3D.preInit(THREE);
	var stats = new Stats();  document.body.appendChild( stats.dom );
	var gui = new dat.GUI();

	var params = { camPosX:0.0,camPosY:1,camPosZ:0,   fogCol:0x010000,fogDensity:4.2,   Bloom:{intensity:1.2,radius:0.5,threshold:0.1},    };
	var gParams = { RESTART:ReInit,exposure:1.4,  lightCol:0xff2222,lightIntensity:0.2,lightPosX:0,lightPosY:0.5,lightPosZ:-3,  pointsOpacity:0.09,  };
	var hiddenParams = { HiddenParams:params, };
	var showParams = { MainParams:gParams, };
	MY3D.addGuiParams(gui, hiddenParams, false, 10,0.01);
	MY3D.addGuiParams(gui, showParams, true, 10,0.01);


	const MAX_Y = 4;
	var light, points;
	ReInit();
	function ReInit0(){
	  scene = new THREE.Scene();
	  scene.add(camera);  
	  renderer.toneMapping = THREE.ReinhardToneMapping;
	  renderer.shadowMap.enabled = true;  
	  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
	  MY3D.initBloom(params.Bloom.intensity,params.Bloom.radius,params.Bloom.threshold);  
	}
	function ReInit(){
	  ReInit0();  
	  
	  light = new THREE.PointLight( gParams.lightCol, gParams.lightIntensity, 10, 1.9 );
	  scene.add( light );
	  var lightPane = new THREE.Mesh( new THREE.PlaneGeometry( 0.4,0.4 ), new THREE.MeshStandardMaterial() );  // new THREE.MeshBasicMaterial( {color: 0x00ff00} )
	  lightPane.position.z = -0.1;
	  light.add( lightPane );  
	  
	  var bumpMap = new THREE.TextureLoader().load("https://cdn.rawgit.com/chrismcg61/TechDemos/1.94/Media/Concrete.jpg");
	  bumpMap.wrapS = THREE.RepeatWrapping;   bumpMap.wrapT = THREE.RepeatWrapping;   bumpMap.repeat.set( 10, 10 );
	  const floorMat = new THREE.MeshStandardMaterial( {roughness:0.7,metalness:0.1, side:THREE.DoubleSide, bumpMap:bumpMap,bumpScale:0.05} );
	  // const wallMat = floorMat.clone();   wallMat.bumpScale=0.9;  wallMat.metalness=0.4;
	  const FLOOR_SIZE = 90;
	  const floor = new THREE.Mesh( new THREE.PlaneGeometry( FLOOR_SIZE,FLOOR_SIZE, 3,3 ),   floorMat );
	  floor.rotation.x = -Math.PI/2;
	  scene.add( floor );  
	  const wall1 = floor.clone();  wall1.position.x = 6;  wall1.rotation.y = -Math.PI/2;  
	  scene.add( wall1 );
	  const wall2 = wall1.clone(); wall2.position.x = -wall1.position.x;
	  scene.add( wall2 );
	  
	  
	  var geometry = new THREE.BufferGeometry();
	  var positions = [];   var colors = [];   // new THREE.Color()
	  for ( let i = 0; i < 30000; i ++ ) {
		positions.push( 10*(Math.random()-0.5), MAX_Y*Math.random(), 12*(Math.random()-1) );
		colors.push( Math.random(), Math.random(), Math.random() );
	  }
	  geometry.setAttribute( 'position', new THREE.Float32BufferAttribute( positions, 3 ) );
	  geometry.setAttribute( 'color', new THREE.Float32BufferAttribute( colors, 3 ) );
	  geometry.computeBoundingSphere();
	  //
	  var sprite = new THREE.TextureLoader().load("https://cdn.rawgit.com/mrdoob/three.js/r138/examples/textures/sprites/snowflake2.png"); 
	  points = new THREE.Points( geometry,  
		new THREE.PointsMaterial({size:0.3,vertexColors:true, map:sprite, blending:THREE.AdditiveBlending, depthTest:false,depthWrite:true, transparent:true,opacity:gParams.pointsOpacity})  );
	  scene.add( points ); 
	}


	animate();
	function animate() {
	  var now = Date.now()*0.0005;
	  requestAnimationFrame( animate );
	  composer.render();
	  // renderer.render( scene, camera );
	  stats.update();
	  
	  renderer.toneMappingExposure = Math.pow( gParams.exposure, 4.0 );
	  scene.background = new THREE.Color( params.fogCol );
	  scene.fog = new THREE.FogExp2( params.fogCol, params.fogDensity*0.01 );      
	  camera.position.set(params.camPosX,params.camPosY,params.camPosZ);
	  {
		light.position.set(gParams.lightPosX,  gParams.lightPosY,  gParams.lightPosZ);  //  + 0.3*Math.sin(now)
		light.intensity = gParams.lightIntensity;
		light.color = new THREE.Color(gParams.lightCol);
	  }
	  
	  {
		var positions = points.geometry.attributes.position.array;
		for ( var i = 0; i < positions.length; i += 3 ) {
		  positions[i+1] += i/(500*positions.length);
		  if( positions[i+1]>MAX_Y ) positions[i+1] = -1;
		}
		points.geometry.attributes.position.needsUpdate = true;
		points.material.opacity = gParams.pointsOpacity;
	  }
	}
</script>

</html>
