<!DOCTYPE html>
<html>
<body>
<head>
	<title>THREEJS DemoLib Advanced 3</title>
</head>

<script src="https://cdn.rawgit.com/chrismcg61/TechDemos/r252/MyLibs/ThreeMin/My3D.js"></script>
<script type="importmap">
  {
    "imports": {
      "three": "https://cdn.rawgit.com/mrdoob/three.js/r157/build/three.module.js",
      "three/addons/": "https://cdn.rawgit.com/mrdoob/three.js/r157/examples/jsm/"
    }
  }
</script>
  

  
<div>☰☰☰☰☰ fragShader : </div>
<textarea id="myTxtArea" name="" rows="20" cols="110">
  MY TEXT
</textarea>
	


  
  
<script type="module">
import * as __THREE from 'three';
import Stats from 'three/addons/libs/stats.module.js';
import { GUI } from 'three/addons/libs/lil-gui.module.min.js';
//
var POSTFX = {};
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
{
  POSTFX.EffectComposer = EffectComposer
  POSTFX.RenderPass = RenderPass
}
import { SSRPass } from 'three/addons/postprocessing/SSRPass.js';
import { ReflectorForSSRPass } from 'three/addons/objects/ReflectorForSSRPass.js';
{
  POSTFX.SSRPass = SSRPass
  POSTFX.ReflectorForSSRPass = ReflectorForSSRPass
}


var stats = new Stats();  document.body.appendChild( stats.dom );
var params = {
  folder1:"INIT_CONFIG", Scene1Factor:0.99,Scene2Factor:0.1,RENDER_FX:false,fxSelect:12, 
  folder2:"SCENE", ReInit:ReInit, meshNb:4,meshDetail:1, castShadow:true, backCol:0x004444,dirLightCol:0x111111,camLightCol:0x888888, pLightCamPosZ:0.9, camPosX:0,camPosY:0.5,camPosZ:0.9,
  folder3:"OBJ", speedFactor:0.01, objPosX:0,objPosY:0,objPosZ:0, 
}
var gui = new GUI();
MY3D.initGui(params, gui, {M0_Gamma:0,M1_ColorCorr:1,M2_Tone:2,M3_Bloom:3,M4_Bokeh:4,M5_Film:5,M6_DotScreen:6,M7_Color:7,M8_Vignette:8,M9_Output:9,M10_Fxaa:10,M11_Pixel:11,M12_Ssr:12,M13_None:13,})
gui.folders[0].close()
// gui.folders[1].close()

MY3D.HH=800;  MY3D.WW=MY3D.HH*1.3;
MY3D.initWebglRenderer(__THREE)



var fragShader = 
`
  varying vec2 vUv;
  varying vec3 vColor;
  varying vec4 vPos;
  //
  uniform float time;
  uniform float noiseScale;
  uniform sampler2D noiseMap;
  uniform sampler2D diffuseMap;
  void main()	{
   vec4 colDiffuse = texture2D(diffuseMap,  vUv);
   vec4 colNoise = texture2D(noiseMap,  noiseScale*vPos.xy);

   float aa = (colNoise.r + colNoise.g + colNoise.b) / 3.0;
   aa = 0.5 + 0.5 * sin(time * aa);

   float dist = length(vUv - vec2(0.5,0.5));
   float rr = 0.5 + 0.5*sin( dist * 90.0 + time);

   gl_FragColor = vec4( rr,1.0,1.0,  aa );
   if(aa < 0.3) discard;
  }
`;
myTxtArea.value = fragShader
//
ReInit()
function ReInit() {
  MY3D.initSceneBackground()
  MY3D.initScene2()
  MY3D.composerInit( POSTFX, params )
  MY3D.addSsrGroundReflector(POSTFX)
  //
  scene.rotGroup = new THREE.Group();
  scene.add( scene.rotGroup )
  {
    var shaderMaterial = myShaderMaterial()
    
    const NB_QUAD = params.meshNb
    var newInstancedMesh = new THREE.InstancedMesh( new THREE.PlaneGeometry( ),  shaderMaterial,  NB_QUAD );
    for ( var ii=0; ii<NB_QUAD; ii++ ) {      
      var newShaderMesh = new THREE.Mesh( new THREE.PlaneGeometry( ),  shaderMaterial );
      newShaderMesh.position.set( sRand(1),0.5,-rand(1) )
      scene.add( newShaderMesh );
    }        
  }  
}

function myShaderMaterial(){
  var shaderMaterial = MY3D.newShaderMaterial();  //new THREE.ShaderMaterial({})
  shaderMaterial.uniforms.noiseScale.value = 0.5
  shaderMaterial.fragmentShader = myTxtArea.value
  //
  setInterval( function(){
    shaderMaterial.uniforms.time.value += 0.1
  },   30)   
  //
  return shaderMaterial
}

  
// var lastT = performance.now()  //ms since Page Load
animate();
function animate() {
  camPLight.rotation.y += 2*params.speedFactor  
  // camPLight.position.x = 0.05*Math.sin( 0.001*performance.now() )
  // scene.rotGroup.rotation.z += 5*params.speedFactor  
  {
    camera.position.set( params.camPosX, params.camPosY, params.camPosZ )  
    scene.background = new THREE.Color( params.backCol )
    directionalLight.color = new THREE.Color( params.dirLightCol )
    camPLight.position.z=params.pLightCamPosZ; camPLight.color=new THREE.Color(params.camLightCol); camPLight.castShadow=params.castShadow;
    scene.rotGroup.position.set( params.objPosX, params.objPosY, params.objPosZ )  
  }
  //
  stats.update()  
  MY3D.myRender_Advanced(params)
  // renderer.render( scene, camera );
  requestAnimationFrame( animate );
}
</script>


  
</body>
</html>
