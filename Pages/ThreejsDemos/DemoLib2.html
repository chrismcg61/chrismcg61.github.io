<!DOCTYPE html>
<html>
<body>
<head>
	<title>THREEJS DemoLib 2</title>
</head>

<script src="https://cdn.rawgit.com/chrismcg61/TechDemos/r246/MyLibs/ThreeMin/My3D.js"></script>
<script type="importmap">
  {
    "imports": {
      "three": "https://cdn.rawgit.com/mrdoob/three.js/r157/build/three.module.js",
      "three/addons/": "https://cdn.rawgit.com/mrdoob/three.js/r157/examples/jsm/"
    }
  }
</script>



  
  
<script type="module">
import * as __THREE from 'three';
import Stats from 'three/addons/libs/stats.module.js';
import { GUI } from 'three/addons/libs/lil-gui.module.min.js';

// UTILS :
import * as BufferGeometryUtils from 'three/addons/utils/BufferGeometryUtils.js';
import { TessellateModifier } from 'three/addons/modifiers/TessellateModifier.js';
import { FontLoader } from 'three/addons/loaders/FontLoader.js';
import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
//
import { GPUComputationRenderer } from 'three/addons/misc/GPUComputationRenderer.js';

// POST-FX :
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';
import { GammaCorrectionShader } from 'three/addons/shaders/GammaCorrectionShader.js';
import { ColorCorrectionShader } from 'three/addons/shaders/ColorCorrectionShader.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
import { ACESFilmicToneMappingShader } from 'three/addons/shaders/ACESFilmicToneMappingShader.js';
//
import { FXAAShader } from 'three/addons/shaders/FXAAShader.js';
import { RenderPixelatedPass } from 'three/addons/postprocessing/RenderPixelatedPass.js';
import { BokehPass } from 'three/addons/postprocessing/BokehPass.js';
import { VignetteShader } from 'three/addons/shaders/VignetteShader.js';
import { FilmPass } from 'three/addons/postprocessing/FilmPass.js';
import { DotScreenPass } from 'three/addons/postprocessing/DotScreenPass.js';
import { ColorifyShader } from 'three/addons/shaders/ColorifyShader.js';
//
import { SSRPass } from 'three/addons/postprocessing/SSRPass.js';
import { ReflectorForSSRPass } from 'three/addons/objects/ReflectorForSSRPass.js';
//
var POSTFX = {};
{
  POSTFX.EffectComposer = EffectComposer
  POSTFX.RenderPass = RenderPass
  POSTFX.OutputPass = OutputPass
  POSTFX.GammaCorrectionShader = GammaCorrectionShader
  POSTFX.ColorCorrectionShader = ColorCorrectionShader
  POSTFX.UnrealBloomPass = UnrealBloomPass
  POSTFX.ShaderPass = ShaderPass
  POSTFX.ACESFilmicToneMappingShader = ACESFilmicToneMappingShader
  POSTFX.FXAAShader = FXAAShader
  POSTFX.RenderPixelatedPass = RenderPixelatedPass
  POSTFX.BokehPass = BokehPass
  POSTFX.VignetteShader = VignetteShader
  POSTFX.FilmPass = FilmPass
  POSTFX.DotScreenPass = DotScreenPass
  POSTFX.ColorifyShader = ColorifyShader
  POSTFX.SSRPass = SSRPass
  POSTFX.ReflectorForSSRPass = ReflectorForSSRPass
}

/***********************************************************************************/
/***********************************************************************************/

var stats = new Stats();  document.body.appendChild( stats.dom );
var params = {  
  folder1:"SSR",maxDistance:1.9,thickness:0.05,opacity:0.9,distanceAttenuation:false,fresnel:false,blur:false,bouncing:false,
  
  folder2:"INIT_CONFIG", GroundRes:16,GroundBump:0.01, meshNb:90,  Scene1Factor:0.99,Scene2Factor:0.2,  
  
  folder3:"SCENE",   fxSelect:12,REINIT:ReInit,MY_VIEWPORT:true,RENDER_FX:true,castShadow:true,  
    backCol:0x004488,dirLightCol:0x111111,camLightCol:0xaaaaaa, pLightCamPosZ:-1.1,
  
  folder7:"CAM",  camPosX:0.5,camPosY:0.5,camPosZ:2.5,
  
  folder8:"MY_OBJ", speedFactor:0.05, ObjPosX:6.5,ObjPosY:20.1,ObjPosZ:-0.8,   
}

var gui = new GUI();   
MY3D.initGui(params, gui, {M0_Gamma:0,M1_ColorCorr:1,M2_Tone:2,M3_Bloom:3,M4_Bokeh:4,M5_Film:5,M6_DotScreen:6,M7_Color:7,M8_Vignette:8,M9_Output:9,M10_Fxaa:10,M11_Pixel:11,M12_Ssr:12,M13_None:13,})
gui.folders[0].close()
gui.folders[1].close()


MY3D.HH=800;  MY3D.WW=MY3D.HH*1.0;

MY3D.initWebglRenderer(__THREE)
MY3D.initSceneBackground()



var shinyMesh;
//
initMyScene()
function ReInit() {
  MY3D.initSceneBackground()
  initMyScene()
}
function updateBackgroundConfig() {
  camera.position.set( params.camPosX, params.camPosY, params.camPosZ )  
  scene.background = new THREE.Color( params.backCol )
  directionalLight.color = new THREE.Color( params.dirLightCol )
  directionalLight.castShadow = camPLight.castShadow = params.castShadow
  camPLight.position.z = params.pLightCamPosZ
  camPLight.color = new THREE.Color( params.camLightCol )
  ground.material.displacementScale = params.GroundBump
  scene.rotGroup.position.set(params.ObjPosX,params.ObjPosY,params.ObjPosZ)
  if( typeof composer.ssrPass !== 'undefined' ){  //composer.ssrPass.selects.push( shinyMesh )
    composer.ssrPass.maxDistance = params.maxDistance
    composer.ssrPass.groundReflector.thickness = composer.ssrPass.thickness = 0.1*params.thickness
    composer.ssrPass.groundReflector.opacity = composer.ssrPass.opacity = params.opacity
    composer.ssrPass.groundReflector.distanceAttenuation = composer.ssrPass.distanceAttenuation = params.distanceAttenuation
    composer.ssrPass.groundReflector.fresnel = composer.ssrPass.fresnel = params.fresnel
    composer.ssrPass.groundReflector.blur = composer.ssrPass.blur = params.blur
    composer.ssrPass.groundReflector.bouncing = composer.ssrPass.bouncing = params.bouncing  
  }
}
function initMyScene() {
  ground.position.y = -0.05;
  ground.geometry = new THREE.PlaneGeometry(90,90, params.GroundRes,params.GroundRes);  //ground.material = new THREE.MeshPhysicalMaterial({})
  
  scene.rotGroup = new THREE.Group();
  scene.add( scene.rotGroup )     

  if( typeof MY3D.initComposer !== 'undefined' ){
    MY3D.initComposer( POSTFX, params )    
    MY3D.addSsrGroundReflector( POSTFX )    
  }
  initScene2()

  
  shinyMesh = new THREE.Mesh( new THREE.TorusGeometry( 0.5,0.1, 8,16 ),  new THREE.MeshStandardMaterial({})  );
  shinyMesh.position.set( 0.5,0.5,1.5 )
  scene.add( shinyMesh );
  composer.ssrPass.selects.push( shinyMesh )
  
  const NB_QUAD = params.meshNb
  var newInstancedMesh = new THREE.InstancedMesh( new THREE.TorusGeometry( 0.05,0.01, 6,8 ),  new THREE.MeshStandardMaterial(),  NB_QUAD );
  for ( var ii=0; ii<NB_QUAD; ii++ ) {
    var dummy = new THREE.Mesh( );    // dummy.scale.set(1,1,1)
    dummy.position.set( Math.random(),Math.random(),Math.random() );  dummy.updateMatrix();
    newInstancedMesh.setMatrixAt( ii, dummy.matrix );
    const myCol = new THREE.Color();  myCol.setHSL( rand(1),1,0.5 )
    newInstancedMesh.setColorAt( ii, myCol );
  }
  newInstancedMesh.receiveShadow = newInstancedMesh.castShadow = params.castShadow;
  scene.add( newInstancedMesh );  
}
function initScene2() {
  camera2 = new THREE.PerspectiveCamera( 60, MY3D.WW/MY3D.HH, 0.01, 1000 );
  camera2.position.set( 0,0,1.7 )
  scene2 = new THREE.Scene();  
  scene2.testMesh = new THREE.Mesh( new THREE.BoxGeometry(),  new THREE.MeshBasicMaterial({})  );
  scene2.add( scene2.testMesh );
}



var lastT = performance.now()  //ms since Page Load
animate()
function myAnimate(){
  if( typeof scene.rotGroup !== 'undefined' ) scene.rotGroup.rotation.y += 0.1*params.speedFactor;
  //
  camPLight.myTorus.rotation.y += 0.9*params.speedFactor;
  camPLight.position.x = 0.4*Math.sin( 0.001*performance.now() )
  //
  shinyMesh.rotation.y += 0.3*params.speedFactor;
}
function animate(){
  if(performance.now() - lastT > 30){
    lastT = performance.now()
    //
    myAnimate()
    updateBackgroundConfig()
    //    
    if(typeof MY3D.myRender_Advanced!=='undefined' && params.MY_VIEWPORT) MY3D.myRender_Advanced(params)
    else  myRender()
    // 
    stats.update()  
  }
  requestAnimationFrame( animate )  
}
function myRender(){
  if( typeof composer !== 'undefined'  &&  params.RENDER_FX)  composer.render();
  else  renderer.render( scene, camera );
}
</script>


  
</body>
</html>
