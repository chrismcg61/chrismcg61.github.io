<!DOCTYPE html>
<html>
<head>
	<title>THREEJS DEMO2</title>
</head>

<body>
</body>

<script src="https://cdn.rawgit.com/chrismcg61/TechDemos/r228/MyLibs/ThreeMin/My3D.js"></script>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.rawgit.com/mrdoob/three.js/r156/build/three.module.js",
    "three/addons/": "https://cdn.rawgit.com/mrdoob/three.js/r156/examples/jsm/"
  }
}
</script>


	
<script type="module">

import * as __THREE from 'three';
import Stats from 'three/addons/libs/stats.module.js';
import { GUI } from 'three/addons/libs/lil-gui.module.min.js';
// import { Reflector } from 'three/addons/objects/Reflector.js';
import { GPUComputationRenderer } from 'three/addons/misc/GPUComputationRenderer.js';
//
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';
import { SSRPass } from 'three/addons/postprocessing/SSRPass.js';
import { ReflectorForSSRPass } from 'three/addons/objects/ReflectorForSSRPass.js';


/***********************************************************************************/
/***********************************************************************************/

function initComposer(){
  // rawRenderer.outputColorSpace = renderer.outputColorSpace = THREE.LinearSRGBColorSpace;  //THREE.SRGBColorSpace  //THREE.NoColorSpace
  // renderer.toneMapping = parseInt( params.toneSelect )  //THREE.NoToneMapping //ACESFilmicToneMapping  //ReinhardToneMapping
  // renderer.toneMappingExposure = params.toneExposure
  //
  composer = new EffectComposer( renderer,  );   //myRenderTarget
  composer.setSize( MY3D.WW,MY3D.HH );
  //
  var renderPass = new RenderPass( scene, camera );
  composer.addPass( renderPass );
  //
  ssrPass = new SSRPass( {
    renderer, scene, camera,
    width:MY3D.WW,height:MY3D.HH,
    selects:[],  // selects: params.groundReflector ? selects : null    
  } );
  if(params.ssrMaxDist > 0) composer.addPass( ssrPass );
  //
  var outputPass = new OutputPass();  // outputPass.uniforms._toneMapping = 2
  composer.addPass( outputPass );
}



var stats = new Stats();  document.body.appendChild( stats.dom );
var params = { 
  folder1:"A", mySelect:0,
  openfolder2:"B", ReInit:ReInit,setHdBackground:MY3D.setHdBackground,MY_VIEWPORT:true,RENDER_FX:false, Scene1Factor:0.99,Scene2Factor:0.15,
    backCol:0x005555,dirLightCol:0x001122, camLightPosZ:-0.5,camLightCol:0x002244, camPosY:0.2,camPosZ:1.3,
  openfolder3:"C", speedFactor:0.08, ssrMaxDist:0.3, objPosX:0,objPosY:0,  
}


MY3D.initGui(params, new GUI())

MY3D.HH = 720
MY3D.WW = MY3D.HH*1.6

MY3D.initWebglRenderer(__THREE)
MY3D.initSceneBackground()


var rotGroup;
var scene2, camera2;
//
var composer;
var ssrPass;
//
initMyScene()
function ReInit() {
  // MY3D.initWebglRenderer(THREE)
  MY3D.initSceneBackground()
  initMyScene()
}
function initMyScene() {
  // MY3D.setHdBackground()
  directionalLight.color = new THREE.Color( params.dirLightCol );
  camPLight.color = new THREE.Color( params.camLightCol );  
  camPLight.position.z = params.camLightPosZ
  //
  rotGroup = new THREE.Group();
  scene.add( rotGroup )     
  //
  ground.position.y = -0.3
  // ground.scale.set( 2,2, 1 )
  // ground.material.displacementScale = 0.01
  

  camera2 = new THREE.PerspectiveCamera( 60, MY3D.WW/MY3D.HH, 0.01, 1000 );
  camera2.position.set( 0,0,2 )
  scene2 = new THREE.Scene();  
  var meshScene2 = new THREE.Mesh( new THREE.BoxGeometry(),  new THREE.MeshBasicMaterial({})  );
  scene2.add( meshScene2 );
  
  
  initComposer()
  
  // addSsr_GroundReflector()
  
  // updateSsrConfig()
  
  
  // var newQuad0 = new THREE.Mesh( new THREE.BoxGeometry(0.1,0.9,2),  new THREE.MeshPhysicalMaterial({}) );
  // newQuad0.position.set( -0.5,0.5,0 )
  // scene.add(newQuad0)
  // ssrPass.selects.push( newQuad0 ) 
  // //
  // var newQuad0 = new THREE.Mesh( new THREE.BoxGeometry(0.9,0.9,0.9),  new THREE.MeshPhysicalMaterial({emissive:0xff0000}) );
  // newQuad0.position.set( 0,0.5,0 )
  // scene.add(newQuad0)
  // // ssrPass.selects.push( newQuad0 ) 
  

}
function animSceneBackground(){
  scene.background = new THREE.Color( params.backCol );
  // scene.fog = new THREE.FogExp2( params.backCol, 0.1 );
  directionalLight.color = new THREE.Color( params.dirLightCol );
  camera.position.y = params.camPosY;
  camera.position.z = params.camPosZ;
  //
  camPLight.color = new THREE.Color( params.camLightCol );  
  camPLight.position.x = Math.sin( performance.now()*0.01*params.speedFactor )
  camPLight.position.z = params.camLightPosZ
  camPLight.myTorus.rotation.y += 0.9*params.speedFactor
  //
  if( typeof rotGroup !== 'undefined' ){
    rotGroup.rotation.y += 0.5*params.speedFactor
    rotGroup.position.x = params.objPosX
    rotGroup.position.y = params.objPosY
  }
  ssrPass.maxDistance = params.ssrMaxDist
  if(ssrPass.groundReflector)  ssrPass.groundReflector.maxDistance = params.ssrMaxDist
}





var lastT = performance.now()  //ms since Page Load
animate()
function animate(){
  // if(performance.now() - lastT > 30){}
  animSceneBackground()  
  // if(params.MY_VIEWPORT)  MY3D.myRender_Advanced()
  // else  
  myRender()
  // 
  stats.update()  
  requestAnimationFrame( animate )  
}
function myRender(){
  if(params.RENDER_FX)  composer.render();
  else  renderer.render( scene, camera );
}

	
</script>

</html>
