<!DOCTYPE html>
<html>
<head>
	<title>THREEJS DEMO2</title>
</head>

<body>
</body>

<script src="https://cdn.rawgit.com/chrismcg61/TechDemos/r227/MyLibs/ThreeMin/My3D.js"></script>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.rawgit.com/mrdoob/three.js/r156/build/three.module.js",
    "three/addons/": "https://cdn.rawgit.com/mrdoob/three.js/r156/examples/jsm/"
  }
}
</script>


	
<script type="module">

import * as __THREE from 'three';
import Stats from 'three/addons/libs/stats.module.js';
import { GUI } from 'three/addons/libs/lil-gui.module.min.js';
// import { Reflector } from 'three/addons/objects/Reflector.js';
import { GPUComputationRenderer } from 'three/addons/misc/GPUComputationRenderer.js';
//
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';
import { SSRPass } from 'three/addons/postprocessing/SSRPass.js';
import { ReflectorForSSRPass } from 'three/addons/objects/ReflectorForSSRPass.js';


/***********************************************************************************/
/***********************************************************************************/


var stats = new Stats();  document.body.appendChild( stats.dom );
var params = { 
  folder1:"A", mySelect:0,
  openfolder2:"B", ReInit:ReInit,RENDER_FX:true,scene2Factor:0.15,
    backCol:0x005555,dirLightCol:0x001122, camLightPosZ:-0.5,camLightCol:0x002244, camPosY:0.22,camPosZ:1.3,
  openfolder3:"C", speedFactor:0.08, objPosY:0,  
}


MY3D.initGui(params, new GUI())

MY3D.WW = 1200
MY3D.HH = MY3D.WW/2

MY3D.initWebglRenderer(__THREE)
MY3D.initSceneBackground()


var rotGroup;
var scene2, camera2;
//
var composer;
var ssrPass;
//
initMyScene()
function ReInit() {
  // MY3D.initWebglRenderer(THREE)
  MY3D.initSceneBackground()
  initMyScene()
}
function initMyScene() {
  rotGroup = new THREE.Group();
  scene.add( rotGroup )  
  ground.position.y = -0.3
  // ground.scale.set( 2,2, 1 )
  ground.material.displacementScale = 0.01
  
  camPLight.myTorus = new THREE.Mesh( 
    new THREE.TorusGeometry( 0.15,0.03, 10,30 ),
    new THREE.MeshPhysicalMaterial({transparent:true,opacity:0.8, roughness:0.3,metalness:0.7,})  );
  camPLight.add( camPLight.myTorus );
  camPLight.myTorus.castShadow = true; camPLight.myTorus.receiveShadow = true;
      

  camera2 = new THREE.PerspectiveCamera( 60, MY3D.WW/MY3D.HH, 0.01, 1000 );
  camera2.position.set( 0,0,2 )
  scene2 = new THREE.Scene();  
  var meshScene2 = new THREE.Mesh( new THREE.BoxGeometry(),  new THREE.MeshBasicMaterial({})  );
  scene2.add( meshScene2 );
  
  
  initComposer()
  
  
  var groundReflector = new ReflectorForSSRPass( new THREE.PlaneGeometry( 10, 10 ), {
    clipBias: 0.0003,
    textureWidth: MY3D.WW,textureHeight: MY3D.HH,
    color: 0xffffff,
    useDepthTexture: true,
  } );
  groundReflector.material.depthWrite = false;
  groundReflector.rotation.x = - Math.PI / 2;
  groundReflector.visible = false;
  scene.add( groundReflector );
  //
  ssrPass.groundReflector = groundReflector
  groundReflector.maxDistance = params.ssrMaxDist
  // groundReflector.thickness = 0.005
  groundReflector.opacity = 0.7
  groundReflector.distanceAttenuation = true
  groundReflector.fresnel = true
  groundReflector.blur = true
  // groundReflector.bouncing = false 

}


function initComposer(){
  // rawRenderer.outputColorSpace = renderer.outputColorSpace = THREE.LinearSRGBColorSpace;  //THREE.SRGBColorSpace  //THREE.NoColorSpace
  // renderer.toneMapping = parseInt( params.toneSelect )  //THREE.NoToneMapping //ACESFilmicToneMapping  //ReinhardToneMapping
  // renderer.toneMappingExposure = params.toneExposure
  //
  composer = new EffectComposer( renderer,  );   //myRenderTarget
  composer.setSize( MY3D.WW,MY3D.HH );
  //
  var renderPass = new RenderPass( scene, camera );
  composer.addPass( renderPass );
  //
  ssrPass = new SSRPass( {
    renderer, scene, camera,
    width:MY3D.WW,height:MY3D.HH,
    // maxDistance:0.01,
    // groundReflector: params.groundReflector ? groundReflector : null,
    // selects: params.groundReflector ? selects : null
  } );
  ssrPass.maxDistance = params.ssrMaxDist
  ssrPass.thickness = 0.005
  ssrPass.opacity = 0.2
  ssrPass.distanceAttenuation = true
  ssrPass.fresnel = true
  ssrPass.blur = true
  ssrPass.bouncing = false  
  ssrPass.selects = []
  if(ssrPass.maxDistance>0) composer.addPass( ssrPass );
  //
  var outputPass = new OutputPass();  // outputPass.uniforms._toneMapping = 2
  composer.addPass( outputPass );
}


var lastT = performance.now()
animate();
function myAnimate() {
  var nowMs = performance.now()   //params.speedFactor
  var nowPow4 = Math.floor( nowMs*0.0002 )
  //
  if( typeof rotGroup !== 'undefined' ){
    rotGroup.rotation.y += 0.5*params.speedFactor
    rotGroup.position.y = params.objPosY
  }
  
  ssrPass.maxDistance = params.ssrMaxDist
  ssrPass.groundReflector.maxDistance = params.ssrMaxDist  
}
function myRender() {
  scene.background = new THREE.Color( params.backCol );
  directionalLight.color = new THREE.Color( params.dirLightCol );
  //
  camPLight.color = new THREE.Color( params.camLightCol );  
  camPLight.position.x = Math.sin( performance.now()*0.01*params.speedFactor )
  camPLight.position.z = params.camLightPosZ
  camPLight.myTorus.rotation.y += 0.9*params.speedFactor
  //
  camera.position.y = params.camPosY;
  camera.position.z = params.camPosZ;
  // scene.fog = new THREE.FogExp2( params.backCol, 0.1 );
  {
    renderer.setRenderTarget(null)
    renderer.setScissorTest( true );  
    renderer.setClearColor( 0x000066 );
    renderer.setViewport( 0,0, MY3D.WW,MY3D.HH );
    renderer.setScissor( 0,0, MY3D.WW,MY3D.HH );
  }
  if(params.RENDER_FX) composer.render();
  else  renderer.render( scene, camera );
  //
  if(params.scene2Factor>0){
    renderer.setViewport( 0,0, MY3D.WW*params.scene2Factor,MY3D.HH*params.scene2Factor );
    renderer.setScissor( 0,0, MY3D.WW*params.scene2Factor,MY3D.HH*params.scene2Factor );
    renderer.render( scene2, camera2 );
  }
}
function animate() {
  if(performance.now() - lastT > 30){
    lastT = performance.now()
    myAnimate();
    myRender();
    stats.update();
  }
  requestAnimationFrame( animate )
  // setTimeout(animate, 30)
}
	
</script>

</html>
